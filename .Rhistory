q()
q()
s <- read.csv("NIS/2005/stent")
summary(s)
rm(s)
s <- read.csv("NIS/2005/l")
summary(s)
which(s$DX1 == "5304")
nrow(which(s$DX1 == "5304"))
sum(which(s$DX1 == "5304"))
which(s$DX2 == "5304")
which(s$DX3 == "5304")
which(s$DX4 == "5304")
which(s$DX5 == "5304")
which(s$DX6 == "5304")
which(s$DX7 == "5304")
rm(s)
s <- read.csv("NIS/2009/h")
summary(s)
summary(s$DX3)
summary(s$DX4)
summary(s$PR1)
summary(as.factor(s$PR1))
summary(as.factor(s$PR2))
h <- s[which(s$PR1 == "5304"),]
summary(h)
summary(h$DX1)
which(h$DX1 == "5304")
rm(list=ls())
s <- read.csv("~/NIS/2012/out.csv")
summary(s)
s$DX1 <- as.factor(s$DX1)
summary(s)
setwd("~/NIS")
format_2005 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Char","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Num","Num","Char","Char")
format_2006 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Char","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Num","Num","Char","Char")
format_2007 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Char","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Char","Char","Num","Num","Char","Char")
format_2008 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Char","Num","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Char","Char","Num","Num","Char","Char","Char")
format_2009 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Char","Char","Num","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Char","Char","Num","Num","Char","Char","Char")
format_2010 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Num","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Char","Char","Num","Num","Char","Char","Char","Char")
format_2011 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Char","Char","Char","Num","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Char","Char","Num","Num","Char","Char","Char","Char")
format_2012 <- c("Num","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Char","Char","Char","Num","Num","Num","Char","Char","Num","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Char","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Num","Char","Num","Char","Char","Char","Char")
# Input
# df = data frame containing the samples to be converted
# year = year of NIS data
# format = format for that year
reformat_nis_dataframe <- function(df, format) {
counter = 0
for(f in format) {
if(f == "Num") {
# Num
df[,counter] <- as.numeric(df[,counter])
} else {
# Char
df[,counter] <- as.factor(df[,counter])
}
counter <- counter + 1
}
return(df)
}
library(RSQLite)
library(DBI)
# Input
# year = NIS Year
# dx_list = list of ICD9 diagnoses (list of strings)
# Output
# Dataframe with all variables as Characters
get_by_dx <- function(year, dx_list) {
# Preprocess the ICD9 list
# Remove all periods
dx_list <- gsub("\\.", "", dx_list)
# Convert to a string with each ICD9 diagnosis encased in single quotes
dx_list <- paste("(", toString(paste("'", dx_list, "'", sep="")), ")", sep="")
# Get path to DB by year
db_path <- gsub("y", toString(year), "y/nis_y.db")
# Connection
con = dbConnect(SQLite(), db_path)
if(year > 2008) {
# Years that have 25 DXs
dx_query <- "SELECT * FROM core_y WHERE DX1 IN dx OR DX2 IN dx OR DX3 IN dx OR DX4 IN dx OR DX5 IN dx OR DX6 IN dx OR DX7 IN dx OR DX8 IN dx OR DX9 IN dx OR DX10 IN dx OR DX11 IN dx OR DX12 IN dx OR DX13 IN dx OR DX14 IN dx OR DX15 IN dx OR DX16 IN dx OR DX17 IN dx OR DX18 IN dx OR DX19 IN dx OR DX20 IN dx OR DX21 IN dx OR DX22 IN dx OR DX23 IN dx OR DX24 IN dx OR DX25 IN dx;"
} else {
# Years that have 15 Dx
dx_query <- "SELECT * FROM core_y WHERE DX1 IN dx OR DX2 IN dx OR DX3 IN dx OR DX4 IN dx OR DX5 IN dx OR DX6 IN dx OR DX7 IN dx OR DX8 IN dx OR DX9 IN dx OR DX10 IN dx OR DX11 IN dx OR DX12 IN dx OR DX13 IN dx OR DX14 IN dx OR DX15 IN dx;"
}
# Put the correct year
dx_query <- gsub("y", toString(year), dx_query)
# Put the correct list of ICD9 diagnoses
dx_query <- gsub("dx", dx_list, dx_query)
# Perform the query
q <- dbSendQuery(con, dx_query)
# Get the data
db_data <- dbFetch(q, n=-1)
# Clear the query to prevent memory leaks
dbClearResult(q)
# Return all results
return(db_data)
}
# Input
# year = NIS Year
# dx_list = list of ICD9 procedures (list of strings)
# Output
# Dataframe with all variables as Characters
get_by_pr <- function(year, pr_list) {
# Preprocess the ICD9 list
# Remove all periods
pr_list <- gsub("\\.", "", pr_list)
# Convert to a string with each ICD9 diagnosis encased in single quotes
pr_list <- paste("(", toString(paste("'", pr_list, "'", sep="")), ")", sep="")
# Get path to DB by year
db_path <- gsub("y", toString(year), "y/nis_y.db")
# Connection
con = dbConnect(SQLite(), db_path)
# All years have 15 PRs
pr_query <- "SELECT * FROM core_y WHERE PR1 IN pr OR PR2 IN pr OR PR3 IN pr OR PR4 IN pr OR PR5 IN pr OR PR6 IN pr OR PR7 IN pr OR PR8 IN pr OR PR9 IN pr OR PR10 IN pr OR PR11 IN pr OR PR12 IN pr OR PR13 IN pr OR PR14 IN pr OR PR15 IN pr;"
# Put the correct year
pr_query <- gsub("y", toString(year), pr_query)
# Put the correct list of ICD9 diagnoses
pr_query <- gsub("pr", pr_list, pr_query)
# Perform the query
q <- dbSendQuery(con, pr_query)
# Get the data
db_data <- dbFetch(q, n=-1)
# Clear the query to prevent memory leaks
dbClearResult(q)
# Return all results
return(db_data)
}
e_2005 <- get_by_dx(2005,"530.4")
e_2005 <- reformat_nis_dataframe(e_2005, format_2005)
summary(e_2005)
e <- e_2005
e[,1] <- as.numeric(e[,1])
rm(e)
e_2005 <- reformat_nis_dataframe(e_2005, format_2005)
reformat_nis_dataframe <- function(df, format) {
counter = 1
for(f in format) {
if(f == "Num") {
# Num
df[,counter] <- as.numeric(df[,counter])
} else {
# Char
df[,counter] <- as.factor(df[,counter])
}
counter <- counter + 1
}
return(df)
}
e_2005 <- reformat_nis_dataframe(e_2005, format_2005)
summary(e_2005)
e_2006 <- get_by_dx(2005, "530.4")
e_2006 <- reformat_nis_dataframe(e_2006, format_2006)
e_2006 <- get_by_dx(2006, "530.4")
e_2006 <- reformat_nis_dataframe(e_2006, format_2006)
e_2007 <- get_by_dx(2007, "530.4")
e_2007 <- reformat_nis_dataframe(e_2007, format_2007)
e_2008 <- get_by_dx(2008, "530.4")
e_2008 <- reformat_nis_dataframe(e_2008, format_2008)
e_2009 <- get_by_dx(2009, "530.4")
e_2009 <- reformat_nis_dataframe(e_2009, format_2009)
e_2010 <- get_by_dx(2010, "530.4")
e_2010 <- reformat_nis_dataframe(e_2010, format_2010)
e_2011 <- get_by_dx(2011, "530.4")
e_2011 <- reformat_nis_dataframe(e_2011, format_2011)
e_2012 <- get_by_dx(2012, "530.4")
e_2012 <- reformat_nis_dataframe(e_2012, format_2012)
609 + 586 + 588 + 643 + 758 + 811 + 830 + 786
summary(e_2005$DX1)
summary(e_2005$DX2)
summary(e_2005$DX3)
summary(e_2005$DX4)
summary(e_2005$DX5)
summary(e_2005$DX6)
summary(e_2005$DX7)
summary(e_2005$DX8)
summary(e_2005$DX9)
nrows(e_2005[which(e_2005$DX1 == "5304"),])
nrow(e_2005[which(e_2005$DX1 == "5304"),])
nrow(e_2005[which(e_2005$DX1 == "5304"),]) + nrow(e_2005[which(e_2005$DX2 == "5304"),]) + nrow(e_2005[which(e_2005$DX3 == "5304"),]) + nrow(e_2005[which(e_2005$DX4 == "5304"),]) + nrow(e_2005[which(e_2005$DX5 == "5304"),]) + nrow(e_2005[which(e_2005$DX6 == "5304"),]) + nrow(e_2005[which(e_2005$DX7 == "5304"),])+ nrow(e_2005[which(e_2005$DX8 == "5304"),]) + nrow(e_2005[which(e_2005$DX9 == "5304"),]) + nrow(e_2005[which(e_2005$DX10 == "5304"),]) + nrow(e_2005[which(e_2005$DX11 == "5304"),]) + nrow(e_2005[which(e_2005$DX12 == "5304"),]) + nrow(e_2005[which(e_2005$DX13 == "5304"),]) + nrow(e_2005[which(e_2005$DX14 == "5304"),]) + nrow(e_2005[which(e_2005$DX15 == "5304"),])
summary(e_2012)
a <- e_2005$AGEDAY
summary(a)
as.character(a)
a[as.character(a)=="-99"]
a[as.character(a)=="-99"] <- NA
a
a <- e_2005
library(dplyr)
install.packages("dplyr")
a <- get_by_dx(2005, "530.4")
which(a$AMONTH == "-99")
a$AMONTH
which(a$AMONTH == "-9")
summary(a)
a$TOTCHG_X
"-9" %in% a$TOTCHG_X
grep("-9", a$TOTCHG_X)
a$TOTCHG_X[grep("-9", a$TOTCHG_X)] <- NA
a$TOTCHG_X
reformat_nis_dataframe <- function(df, format) {
counter = 1
for(f in format) {
# Remove unknowns
df[,counter][grep("-9", df[,counter])] <- NA
if(f == "Num") {
# Num
df[,counter] <- as.numeric(df[,counter])
} else {
# Char
df[,counter] <- as.factor(df[,counter])
}
counter <- counter + 1
}
return(df)
}
a <- reformat_nis_dataframe(a, format_2005)
summary(a)
a <- get_by_dx(2005, "530.4")
summary(a)
summary(a$TOTCHG)
a$TOTCHG
a$TOTCHG_X
# Input
# df = data frame containing the samples to be converted
# year = year of NIS data
# format = format for that year
reformat_nis_dataframe <- function(df, format) {
counter = 1
for(f in format) {
# Remove unknowns
df[,counter][grep("-[0-9]+", df[,counter])] <- NA
if(f == "Num") {
# Num
df[,counter] <- as.numeric(df[,counter])
} else {
# Char
df[,counter] <- as.factor(df[,counter])
}
counter <- counter + 1
}
return(df)
}
a <- reformat_nis_dataframe(a, format_2005)
summary(a)
